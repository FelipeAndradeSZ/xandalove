<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jardim Virtual üå∏</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0;
      background: linear-gradient(to bottom, #87CEEB, #98D8C8);
      font-family: 'Quicksand', sans-serif;
      overflow: hidden; position: relative; height: 100vh;
    }
    .sky { position: absolute; top: 0; left: 0; width: 100%; height: 70%;
      background: linear-gradient(to bottom, #87CEEB, #B0E0E6); z-index: 1; }
    .ground { position: absolute; bottom: 0; left: 0; width: 100%; height: 30%;
      background: linear-gradient(to bottom, #8B7355, #6B5344); z-index: 2; cursor: pointer; }
    .grass { position: absolute; bottom: 30%; left: 0; width: 100%; height: 8%;
      background: #90EE90; z-index: 3; border-top: 3px solid #228B22; cursor: pointer; }
    .sun { position: absolute; top: 50px; right: 80px; width: 80px; height: 80px;
      background: radial-gradient(circle, #FFD700, #FFA500); border-radius: 50%; z-index: 1; animation: glow 3s ease-in-out infinite; }
    @keyframes glow { 0%,100%{box-shadow:0 0 20px #FFD700;} 50%{box-shadow:0 0 40px #FFD700;} }
    .cloud { position: absolute; background: white; border-radius: 100px; z-index: 1; opacity: .8; }

    .pond {
      position: absolute; bottom: 5%; left: 10%; width: 220px; height: 120px;
      background: radial-gradient(ellipse, #4A90E2, #2E5C8A);
      border-radius: 50%; z-index: 2; cursor: crosshair;
      box-shadow: inset 0 5px 15px rgba(0,0,0,.3), 0 2px 10px rgba(74,144,226,.5);
      animation: water-shimmer 3s ease-in-out infinite;
    }
    @keyframes water-shimmer {
      0%,100%{box-shadow: inset 0 5px 15px rgba(0,0,0,.3), 0 2px 10px rgba(74,144,226,.5);}
      50%{box-shadow: inset 0 5px 20px rgba(0,0,0,.2), 0 2px 15px rgba(100,180,255,.7);}
    }
    @keyframes ripple { 0%{transform: scale(0); opacity: 1;} 100%{transform: scale(3); opacity: 0;} }

    .bee { position: absolute; font-size: 24px; z-index: 10; pointer-events: none; animation: bee-fly linear infinite; }
    @keyframes bee-fly {
      0%{transform: translate(0,0) rotate(0deg);}
      25%{transform: translate(100px,-30px) rotate(10deg);}
      50%{transform: translate(200px,20px) rotate(-5deg);}
      75%{transform: translate(300px,-15px) rotate(8deg);}
      100%{transform: translate(400px,0) rotate(0deg);}
    }

    .worm { position: absolute; font-size: 20px; z-index: 3; animation: worm-crawl 8s linear infinite; cursor: pointer; transition: transform .2s; }
    .worm:hover { transform: scale(1.2); }
    @keyframes worm-crawl {
      0%{transform: translateX(0) scaleX(1);}
      48%{transform: translateX(300px) scaleX(1);}
      50%{transform: translateX(300px) scaleX(-1);}
      98%{transform: translateX(0) scaleX(-1);}
      100%{transform: translateX(0) scaleX(1);}
    }

    .fishing-rod { position: fixed; bottom: 30px; right: 30px; font-size: 32px; cursor: pointer; z-index: 100; transition: transform .2s; filter: drop-shadow(2px 2px 4px rgba(0,0,0,.3)); }
    .fishing-rod:hover { transform: scale(1.15) rotate(-10deg); }
    .fishing-rod.active { animation: fishing 1s ease-in-out; }
    @keyframes fishing { 0%,100%{transform: rotate(0deg);} 25%{transform: rotate(-20deg);} 75%{transform: rotate(20deg);} }

    .fish-counter { position: fixed; bottom: 80px; right: 30px; background: rgba(255,255,255,.95); padding: 10px 15px; border-radius: 15px; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,.2); z-index: 100; }
    .fish-jump { position: absolute; font-size: 28px; z-index: 11; animation: fish-jump-anim 1.5s ease-out forwards; pointer-events: none; }
    @keyframes fish-jump-anim { 0%{transform: translateY(0) rotate(0deg); opacity: 0;} 20%{opacity: 1;} 50%{transform: translateY(-80px) rotate(180deg);} 100%{transform: translateY(0) rotate(360deg); opacity: 0;} }

    /* √Årvore */
    .tree { position: absolute; bottom: 30%; right: 15%; z-index: 4; width: 180px; height: 250px; }
    .tree-trunk { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 40px; height: 120px; background: #8B4513; border-radius: 5px; }
    .tree-leaves { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); width: 140px; height: 140px; background: #228B22; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,.2); }
    .tree-leaves::before { content: ''; position: absolute; top: -30px; left: 20px; width: 100px; height: 100px; background: #2E8B57; border-radius: 50%; }
    .tree-leaves::after { content: ''; position: absolute; top: -30px; right: 20px; width: 100px; height: 100px; background: #32CD32; border-radius: 50%; }
    .tree-apples { position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%); width: 140px; height: 140px; }

    .beehive { position: absolute; bottom: 140px; right: -10px; width: 50px; height: 60px; background: #DAA520; border-radius: 20px 20px 25px 25px; box-shadow: inset 0 -5px 10px rgba(0,0,0,.2); z-index: 5; }
    .beehive::before, .beehive::after { content: ''; position: absolute; left: 0; right: 0; height: 3px; background: #8B6914; }
    .beehive::before { top: 15px; } .beehive::after { top: 30px; }
    .beehive-hole { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px; background: #654321; border-radius: 50%; }

    /* Ma√ß√£s */
    .apple { position: absolute; cursor: pointer; transition: transform .2s; z-index: 6; filter: drop-shadow(2px 2px 3px rgba(0,0,0,.3)); }
    .apple.growing { animation: apple-grow 8s ease-out forwards; pointer-events: none; opacity: 0.5; }
    .apple.ready { animation: apple-sway 3s ease-in-out infinite; cursor: pointer; }
    .apple.ready:hover { transform: scale(1.2) rotate(5deg); }
    @keyframes apple-grow {
      0% { font-size: 8px; opacity: 0; filter: brightness(2) saturate(0.3); }
      30% { opacity: 0.6; font-size: 14px; filter: brightness(1.8) saturate(0.5); }
      60% { font-size: 20px; filter: brightness(1.4) saturate(0.7); }
      100% { font-size: 28px; opacity: 1; filter: brightness(1) saturate(1) drop-shadow(2px 2px 3px rgba(0,0,0,.3)); }
    }
    @keyframes apple-sway { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(5deg); } }

    /* Plantas */
    .plant { position: absolute; cursor: pointer; transition: transform .2s ease; z-index: 4; transform-origin: bottom center; animation: popin .25s ease-out; user-select: none; }
    @keyframes popin { 0%{transform:scale(0); opacity:0;} 100%{transform:scale(1); opacity:1;} }
    .plant:hover { transform: scale(1.06); }
    .sprout { filter: saturate(1.2); }
    .flower { animation: grow 0.8s ease-out; }
    @keyframes grow { 0%{transform:scale(0.6); opacity:0;} 100%{transform:scale(1); opacity:1;} }

    .controls {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(255,255,255,.95); padding: 15px 25px; border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,.2); z-index: 100;
      display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center;
    }
    .flower-btn { width: 50px; height: 50px; border: 3px solid #fff; border-radius: 50%; cursor: pointer; transition: transform .2s; box-shadow: 0 2px 8px rgba(0,0,0,.3); font-size: 28px; display: flex; align-items: center; justify-content: center; }
    .flower-btn:hover { transform: scale(1.1); }
    .flower-btn.selected { border-color:#FFD700; border-width:4px; box-shadow:0 0 15px #FFD700; }
    .tool-btn { padding: 8px 14px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer; background:#4FC3F7; color:#00334d; box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    .tool-btn.active { outline: 3px solid #0288D1; }
    .clear-btn { padding:8px 16px; background:#ff6b6b; color:white; border:none; border-radius:15px; font-size:14px; cursor:pointer; transition:all .3s; }
    .clear-btn:hover { background:#ff4757; }
    .reset-btn { padding:8px 16px; background:#b00020; color:white; border:none; border-radius:15px; font-size:14px; cursor:pointer; transition:all .3s; }
    .reset-btn:hover { background:#8a001a; }

    .info { color:#ff69b4; font-weight:600; font-size:16px; text-align:center; width:100%; }
    .counter { background:#ff69b4; color:white; padding:8px 16px; border-radius:15px; font-weight:600; }
    .stats { display:flex; gap:10px; align-items:center; }
    .stat-box { background:white; padding:6px 12px; border-radius:12px; font-size:13px; color:#333; font-weight:600; }
    .stat-good { border:2px solid #4CAF50; }
    .stat-bad  { border:2px solid #ff6b6b; }

    .connection-status { position: fixed; top: 80px; right: 20px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; z-index: 101; transition: all .3s; }
    .status-connected { background:#4CAF50; color:white; } .status-disconnected { background:#ff6b6b; color:white; } .status-loading { background:#FFA500; color:white; }

    .back-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background:#ff69b4; color:white; border:none; border-radius:20px; font-size:16px; font-weight:700; cursor:pointer; box-shadow:0 4px 15px rgba(255,105,180,.4); z-index: 101; transition: all .25s ease; }
    .back-btn:hover { background:#ff4081; transform: translateX(-50%) scale(1.05); }

    .drop { position: absolute; font-size: 18px; pointer-events: none; z-index: 5; animation: drop-anim .7s ease-out forwards; }
    @keyframes drop-anim { 0%{transform: translateY(-10px); opacity:0;} 20%{opacity:1;} 100%{transform: translateY(-35px); opacity:0;} }
  </style>
</head>
<body>
  <div class="sky"></div>
  <div class="sun"></div>
  <div id="connectionStatus" class="connection-status status-loading">Conectando...</div>

  <div class="grass"></div>
  <div class="ground" id="ground"></div>
  
  <div class="pond" id="pond"></div>
  
  <!-- √Årvore com colmeia e ma√ß√£s -->
  <div class="tree">
    <div class="tree-trunk"></div>
    <div class="tree-leaves"></div>
    <div class="tree-apples" id="treeApples"></div>
    <div class="beehive"><div class="beehive-hole"></div></div>
  </div>
  
  <div class="fishing-rod" id="fishingRod" title="Clique para pescar!">üé£</div>
  <div class="fish-counter">üêü <span id="fishCount">0</span> | ü™± <span id="wormCount">0</span> | üçé <span id="appleCount">0</span></div>

  <div class="controls">
    <div class="info">Clique no ch√£o para plantar. Colete minhocas ü™± e pesque no lago! üé£</div>
    <div class="flower-btn selected" data-flower="üå∏" style="background:#FFB6C1;">üå∏</div>
    <div class="flower-btn" data-flower="üå∫" style="background:#FF69B4;">üå∫</div>
    <div class="flower-btn" data-flower="üåª" style="background:#FFD700;">üåª</div>
    <div class="flower-btn" data-flower="üå∑" style="background:#FF1493;">üå∑</div>
    <div class="flower-btn" data-flower="üåπ" style="background:#DC143C;">üåπ</div>
    <div class="flower-btn" data-flower="üåº" style="background:#FFFFE0;">üåº</div>

    <button id="waterBtn" class="tool-btn">üöø Regador</button>

    <div class="stats">
      <div class="counter">Plantas: <span id="count">0</span></div>
      <div class="stat-box stat-good">‚ûï <span id="added">0</span></div>
      <div class="stat-box stat-bad">‚ûñ <span id="removed">0</span></div>
    </div>
    <button class="clear-btn" onclick="clearGarden()">Limpar Jardim</button>
    <button class="reset-btn" onclick="resetAll()">Zerar Tudo</button>
  </div>

  <button class="back-btn" onclick="goBack()">üîô Voltar</button>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    /* ===================== Firebase ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyA9cS4tdhvNE3Wx-JYa5Wfft0TCQLVuMzg",
      authDomain: "xandalove-2f7f3.firebaseapp.com",
      databaseURL: "https://xandalove-2f7f3-default-rtdb.firebaseio.com",
      projectId: "xandalove-2f7f3",
      storageBucket: "xandalove-2f7f3.firebasestorage.app",
      messagingSenderId: "172297779195",
      appId: "1:172297779195:web:833f5ee0c81bffb4cdbd5e"
    };

    let database, isFirebaseReady = false, hasLoadedFromFirebase = false;
    const statusEl = document.getElementById('connectionStatus');

    /* ===================== Estado ===================== */
    let selectedFlower = 'üå∏', wateringMode = false;
    // plantas e stats (j√° existiam)
    let plants = [];
    let stats = { totalAdded: 0, totalRemoved: 0 };
    // NOVO: invent√°rio persistente
    let inventory = { fish: 0, worms: 0, apples: 0 };

    let isLoading = true;

    /* ===================== Inicializa√ß√£o ===================== */
    try {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === true) {
          isFirebaseReady = true;
          statusEl.textContent = 'üü¢ Conectado';
          statusEl.className = 'connection-status status-connected';
          if (!hasLoadedFromFirebase) { hasLoadedFromFirebase = true; loadFromFirebase(); }
        } else {
          isFirebaseReady = false;
          statusEl.textContent = 'üî¥ Desconectado';
          statusEl.className = 'connection-status status-disconnected';
        }
      });
    } catch (e) {
      statusEl.textContent = 'üî¥ Erro Firebase';
      statusEl.className = 'connection-status status-disconnected';
      isFirebaseReady = false;
      loadFromCookie(); isLoading = false; loadGarden();
    }

    /* ===================== C√©u e sele√ß√£o ===================== */
    function createCloud(left, top, width) {
      const cloud = document.createElement('div');
      cloud.className = 'cloud';
      cloud.style.left = left + '%';
      cloud.style.top = top + 'px';
      cloud.style.width = width + 'px';
      cloud.style.height = (width * 0.6) + 'px';
      document.querySelector('.sky').appendChild(cloud);
    }
    createCloud(10, 80, 100);
    createCloud(60, 120, 120);
    createCloud(85, 60, 90);

    document.querySelectorAll('.flower-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.flower-btn').forEach(b => b.classList.remove('selected'));
        this.classList.add('selected');
        selectedFlower = this.dataset.flower;
      });
    });

    const waterBtn = document.getElementById('waterBtn');
    waterBtn.addEventListener('click', () => {
      wateringMode = !wateringMode;
      waterBtn.classList.toggle('active', wateringMode);
      waterBtn.textContent = wateringMode ? 'üöø Regador (ativo)' : 'üöø Regador';
    });

    /* ===================== Intera√ß√£o: plantar ===================== */
    const ground = document.getElementById('ground');
    const grass  = document.querySelector('.grass');
    [ground, grass].forEach(el => {
      el.addEventListener('click', (e) => {
        const rect = ground.getBoundingClientRect();
        const x = e.clientX;
        const y = Math.min(rect.bottom - 5, Math.max(rect.top + 5, e.clientY));
        plantSprout(x, y);
      });
    });

    function plantSprout(x, y) {
      const size = (28 + Math.random() * 18) + 'px';
      const item = {
        id: Date.now().toString() + '-' + Math.random().toString(36).slice(2),
        x, y, size, type: selectedFlower, stage: 'sprout', water: 0, waterNeeded: 3
      };
      plants.push(item);
      stats.totalAdded++;
      renderPlant(item);
      saveAll(); // salva plantas + stats + inventory
      updateStats();
    }

    function waterPlant(id) {
      const p = plants.find(pl => pl.id === id);
      if (!p) return;
      const drop = document.createElement('div');
      drop.className = 'drop'; drop.textContent = 'üíß';
      drop.style.left = (p.x + 6) + 'px'; drop.style.top = (p.y - 6) + 'px';
      document.body.appendChild(drop); setTimeout(() => drop.remove(), 700);
      p.water++;
      if (p.water >= p.waterNeeded && p.stage === 'sprout') {
        p.stage = 'flower';
        const el = document.querySelector(`[data-id="${p.id}"]`);
        if (el) { el.textContent = p.type; el.classList.remove('sprout'); el.classList.add('flower'); }
      }
      savePlantsAndStats();
    }

    function removePlant(id) {
      const idx = plants.findIndex(p => p.id === id);
      if (idx > -1) {
        plants.splice(idx, 1);
        stats.totalRemoved++;
        if (isFirebaseReady) {
          database.ref(`garden/plants/${id}`).remove();
          database.ref('garden/stats').set(stats);
        } else saveToCookie();
        const el = document.querySelector(`[data-id="${id}"]`); if (el) el.remove();
        updateStats();
      }
    }

    function renderPlant(p) {
      const el = document.createElement('div');
      el.className = 'plant ' + (p.stage === 'sprout' ? 'sprout' : 'flower');
      el.textContent = (p.stage === 'sprout') ? 'üå±' : p.type;
      el.style.fontSize = p.size; el.style.left = p.x + 'px'; el.style.top = p.y + 'px';
      el.dataset.id = p.id;
      el.onclick = function(e) {
        e.stopPropagation();
        if (p.stage === 'sprout' && wateringMode) waterPlant(p.id);
        else if (!wateringMode) removePlant(p.id);
      };
      document.body.appendChild(el);
    }

    /* ===================== Pesca / Minhocas / Ma√ß√£s ===================== */
    const pond = document.getElementById('pond');
    const fishingRod = document.getElementById('fishingRod');

    fishingRod.addEventListener('click', function() {
      if (inventory.worms <= 0) {
        alert('Voc√™ precisa de minhocas para pescar! ü™±\nClique nas minhocas que aparecem na terra.');
        return;
      }
      inventory.worms--;
      updateInventoryUI(); saveInventory();

      fishingRod.classList.add('active');
      setTimeout(() => fishingRod.classList.remove('active'), 1000);

      if (Math.random() < 0.7) {
        setTimeout(() => {
          inventory.fish++;
          updateInventoryUI(); saveInventory();
          createFishJump();
        }, 1200);
      } else {
        setTimeout(() => alert('O peixe escapou! üé£'), 1200);
      }
    });

    pond.addEventListener('click', function(e) {
      const ripple = document.createElement('div');
      ripple.style.position = 'absolute';
      ripple.style.left = (e.clientX - pond.getBoundingClientRect().left - 15) + 'px';
      ripple.style.top = (e.clientY - pond.getBoundingClientRect().top - 15) + 'px';
      ripple.style.width = '30px'; ripple.style.height = '30px'; ripple.style.borderRadius = '50%';
      ripple.style.border = '2px solid rgba(255,255,255,.8)';
      ripple.style.animation = 'ripple 1s ease-out forwards';
      ripple.style.pointerEvents = 'none';
      pond.appendChild(ripple);
      setTimeout(() => ripple.remove(), 1000);
    });

    function createFishJump() {
      const fish = document.createElement('div');
      fish.className = 'fish-jump';
      fish.textContent = ['üêü', 'üê†', 'üê°'][Math.floor(Math.random() * 3)];
      const pondRect = pond.getBoundingClientRect();
      fish.style.left = (pondRect.left + pondRect.width/2 - 15) + 'px';
      fish.style.top = (pondRect.top + pondRect.height/2) + 'px';
      document.body.appendChild(fish);
      setTimeout(() => fish.remove(), 1500);
    }

    function updateInventoryUI() {
      document.getElementById('fishCount').textContent  = inventory.fish;
      document.getElementById('wormCount').textContent  = inventory.worms;
      document.getElementById('appleCount').textContent = inventory.apples;
    }

    // Minhocas peri√≥dicas
    function createWorm() {
      const worm = document.createElement('div');
      worm.className = 'worm';
      worm.textContent = 'ü™±';
      worm.style.bottom = (30 + Math.random() * 100) + 'px';
      worm.style.left = '20px';
      worm.onclick = function(e) {
        e.stopPropagation();
        inventory.worms++;
        updateInventoryUI(); saveInventory();
        worm.remove();
        const msg = document.createElement('div');
        msg.style.position = 'absolute'; msg.style.left = e.clientX + 'px'; msg.style.top = e.clientY + 'px';
        msg.style.fontSize = '20px'; msg.style.zIndex = '1000'; msg.style.animation = 'drop-anim .7s ease-out forwards';
        msg.textContent = '+1 ü™±'; document.body.appendChild(msg); setTimeout(() => msg.remove(), 700);
      };
      document.body.appendChild(worm);
      setTimeout(() => worm.remove(), 8000);
    }

    // Ma√ß√£s que crescem na √°rvore
    function createApples() {
      const treeApples = document.getElementById('treeApples');
      const positions = [
        { left: '15px', top: '25px' }, { left: '45px', top: '35px' }, { left: '75px', top: '30px' },
        { left: '100px', top: '40px' }, { left: '30px', top: '50px' }, { left: '90px', top: '20px' },
        { left: '60px', top: '10px' }
      ];
      positions.forEach((pos, i) => setTimeout(() => growApple(treeApples, pos, i), i * 1500));
    }

    function growApple(container, pos, index) {
      const apple = document.createElement('div');
      apple.className = 'apple growing';
      apple.textContent = 'üçé';
      apple.style.left = pos.left; apple.style.top = pos.top;
      container.appendChild(apple);

      setTimeout(() => {
        apple.classList.remove('growing'); apple.classList.add('ready');
        apple.style.animationDelay = (index * 0.3) + 's';
        apple.onclick = function(e) {
          e.stopPropagation();
          inventory.apples++;
          updateInventoryUI(); saveInventory();

          apple.style.animation = 'none'; apple.style.transform = 'scale(0)'; apple.style.opacity = '0'; apple.style.transition = 'all 0.3s ease';
          const msg = document.createElement('div');
          msg.style.position = 'absolute'; msg.style.left = e.clientX + 'px'; msg.style.top = e.clientY + 'px';
          msg.style.fontSize = '20px'; msg.style.zIndex = '1000'; msg.style.animation = 'drop-anim .7s ease-out forwards';
          msg.textContent = '+1 üçé'; document.body.appendChild(msg); setTimeout(() => msg.remove(), 700);

          setTimeout(() => { apple.remove(); }, 300);
          setTimeout(() => { growApple(container, pos, index); }, 10000 + Math.random() * 5000);
        };
      }, 8000);
    }

    // Abelhas ‚Äúcosm√©ticas‚Äù
    function createBee() {
      const bee = document.createElement('div');
      bee.className = 'bee'; bee.textContent = 'üêù';
      const useTree = Math.random() < 0.4;
      if (useTree) {
        const tree = document.querySelector('.tree'); const treeRect = tree.getBoundingClientRect();
        bee.style.top = (treeRect.top + 100) + 'px'; bee.style.left = treeRect.right + 'px'; bee.style.animationDuration = '6s'; bee.style.animation = 'none';
        document.body.appendChild(bee);
        let pos = 0; const interval = setInterval(() => {
          pos -= 2; bee.style.transform = `translateX(${pos}px) rotate(${Math.sin(pos/10)*10}deg)`;
          if (Math.abs(pos) > 150) { clearInterval(interval); bee.remove(); setTimeout(createBee, Math.random() * 5000); }
        }, 30);
      } else {
        bee.style.top = (100 + Math.random() * 250) + 'px'; bee.style.left = '-50px';
        bee.style.animationDuration = (8 + Math.random() * 4) + 's';
        document.body.appendChild(bee);
        setTimeout(() => { bee.remove(); setTimeout(createBee, Math.random() * 5000); }, parseFloat(bee.style.animationDuration) * 1000);
      }
    }

    /* ===================== Bot√µes gerais ===================== */
    function clearGarden() {
      if (confirm('Limpar o jardim (manter estat√≠sticas & invent√°rio)?')) {
        if (isFirebaseReady) database.ref('garden/plants').remove();
        document.querySelectorAll('.plant').forEach(f => f.remove());
        plants = [];
        savePlantsAndStats(); // mant√©m inventory
        updateStats();
      }
    }

    function resetAll() {
      if (!confirm('Zerar TUDO? Isso apaga brotos/flores, estat√≠sticas e invent√°rio.')) return;
      plants = []; stats = { totalAdded: 0, totalRemoved: 0 }; inventory = { fish: 0, worms: 0, apples: 0 };
      document.querySelectorAll('.plant').forEach(f => f.remove());
      if (isFirebaseReady) {
        database.ref().update({
          'garden/plants': null,
          'garden/stats': { totalAdded: 0, totalRemoved: 0 },
          'garden/inventory': { fish: 0, worms: 0, apples: 0 }
        });
      }
      deleteCookie('gardenData'); saveToCookie();
      updateStats(); updateInventoryUI();
    }

    function goBack() {
      const target = 'backup.html';
      fetch(target, { method: 'HEAD' })
        .then(r => { if (r.ok) window.location.href = target; else history.back(); })
        .catch(() => history.back());
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') goBack(); });

    /* ===================== Persist√™ncia ===================== */
    function loadFromFirebase() {
      if (!isFirebaseReady) { loadFromCookie(); isLoading = false; loadGarden(); updateInventoryUI(); return; }

      const plantsRef = database.ref('garden/plants');
      const statsRef  = database.ref('garden/stats');
      const invRef    = database.ref('garden/inventory');

      // Carregamento inicial (uma vez)
      Promise.all([plantsRef.once('value'), statsRef.once('value'), invRef.once('value')])
        .then(([pSnap, sSnap, iSnap]) => {
          const pData = pSnap.val(), sData = sSnap.val(), iData = iSnap.val();
          plants = pData ? Object.values(pData) : [];
          if (sData) stats = sData;
          if (iData) inventory = iData;
          isLoading = false;
          loadGarden(); updateInventoryUI();
          listenToChanges();
        })
        .catch(() => { loadFromCookie(); isLoading = false; loadGarden(); updateInventoryUI(); });
    }

    function listenToChanges() {
      if (!isFirebaseReady) return;

      database.ref('garden/plants').on('value', (snapshot) => {
        if (isLoading) return;
        const data = snapshot.val();
        const newPlants = data ? Object.values(data) : [];
        document.querySelectorAll('.plant').forEach(el => {
          const id = el.dataset.id;
          if (!newPlants.find(f => f.id == id)) el.remove();
        });
        newPlants.forEach(p => {
          const exists = document.querySelector(`[data-id="${p.id}"]`);
          if (!exists) renderPlant(p);
          else if (p.stage === 'flower') {
            exists.textContent = p.type;
            exists.classList.remove('sprout'); exists.classList.add('flower');
          }
        });
        plants = newPlants; updateStats();
      });

      database.ref('garden/stats').on('value', (snapshot) => {
        if (isLoading) return;
        const data = snapshot.val(); if (data) { stats = data; updateStats(); }
      });

      // NOVO: inventory em tempo real
      database.ref('garden/inventory').on('value', (snapshot) => {
        if (isLoading) return;
        const data = snapshot.val(); if (data) { inventory = data; updateInventoryUI(); }
      });
    }

    // salva tudo (plants + stats + inventory)
    function saveAll() {
      if (!isFirebaseReady) { saveToCookie(); return; }
      const updates = {};
      plants.forEach(p => { updates[`garden/plants/${p.id}`] = p; });
      updates['garden/stats'] = stats;
      updates['garden/inventory'] = inventory;
      database.ref().update(updates).catch(() => { saveToCookie(); });
    }
    // salva s√≥ plants + stats (usado em clear)
    function savePlantsAndStats() {
      if (!isFirebaseReady) { saveToCookie(); return; }
      const updates = {};
      plants.forEach(p => { updates[`garden/plants/${p.id}`] = p; });
      updates['garden/stats'] = stats;
      database.ref().update(updates).catch(() => { saveToCookie(); });
    }
    // salva s√≥ inventory (chamado ao pegar ma√ß√£/minhoca/pescar)
    function saveInventory() {
      if (!isFirebaseReady) { saveToCookie(); return; }
      database.ref('garden/inventory').set(inventory).catch(() => { saveToCookie(); });
    }

    /* ===================== Cookies (fallback) ===================== */
    function loadFromCookie() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'gardenData') {
          try {
            const data = JSON.parse(decodeURIComponent(value));
            plants = data.plants || [];
            stats  = data.stats  || { totalAdded: 0, totalRemoved: 0 };
            inventory = data.inventory || { fish: 0, worms: 0, apples: 0 };
            return true;
          } catch {}
        }
      }
      return false;
    }
    function saveToCookie() {
      const data = { plants, stats, inventory };
      const expires = new Date(); expires.setFullYear(expires.getFullYear() + 1);
      document.cookie = `gardenData=${encodeURIComponent(JSON.stringify(data))}; expires=${expires.toUTCString()}; path=/`;
    }
    function deleteCookie(name) { document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`; }

    /* ===================== Render b√°sico ===================== */
    function loadGarden() {
      document.querySelectorAll('.plant').forEach(f => f.remove());
      plants.forEach(p => renderPlant(p));
      updateStats();
    }
    function updateStats() {
      document.getElementById('count').textContent = plants.length;
      document.getElementById('added').textContent = stats.totalAdded;
      document.getElementById('removed').textContent = stats.totalRemoved;
    }

    /* ===================== Criaturas (timers) ===================== */
    function initializeCreatures() {
      for (let i = 0; i < 3; i++) setTimeout(() => createBee(), i * 2000);
      setInterval(createWorm, 8000);
      createWorm();
      createApples();
    }

    // start
    loadFromFirebase();
    initializeCreatures();
  </script>
</body>
</html>
